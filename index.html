<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MasterPOS Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background-color: #f3f4f6; touch-action: manipulation; }
        .scanner-container video { border-radius: 1rem; width: 100% !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const db = new Dexie("MasterPOS_DB");
        db.version(1).stores({
            products: '++id, barcode, name, price, stock',
            transactions: '++id, date, total, items'
        });

        // --- Fitur Scanner ---
        function Scanner({ onScan, onClose }) {
            useEffect(() => {
                const scanner = new Html5Qrcode("reader");
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                    (text) => { scanner.stop(); onScan(text); });
                return () => { if (scanner.isScanning) scanner.stop(); };
            }, []);
            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col p-4">
                    <button onClick={onClose} className="ml-auto bg-red-500 text-white px-4 py-2 rounded-xl mb-4">Tutup</button>
                    <div id="reader"></div>
                </div>
            );
        }

        // --- App Utama ---
        function App() {
            const [tab, setTab] = useState('kasir');
            const [cart, setCart] = useState([]);
            const [showScanner, setShowScanner] = useState(false);

            const handleScan = async (code) => {
                const item = await db.products.where('barcode').equals(code).first();
                if (item) {
                    setCart([...cart, {...item, qty: 1}]);
                } else {
                    const name = prompt("Barang baru! Masukkan nama:");
                    const price = prompt("Masukkan harga:");
                    if(name && price) {
                        await db.products.add({ barcode: code, name, price: parseInt(price), stock: 99 });
                        alert("Barang disimpan! Scan sekali lagi.");
                    }
                }
                setShowScanner(false);
            };

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col">
                    <header className="bg-blue-600 p-4 text-white font-black text-center shadow-lg">MASTER POS</header>
                    
                    <main className="flex-1 p-4 overflow-y-auto pb-24">
                        {tab === 'kasir' && (
                            <div>
                                <button onClick={() => setShowScanner(true)} className="w-full bg-blue-500 text-white py-4 rounded-2xl mb-4 font-bold shadow-md">ðŸ“· SCAN BARCODE</button>
                                <div className="bg-white rounded-2xl p-4 shadow-sm">
                                    {cart.map((item, i) => (
                                        <div key={i} className="flex justify-between border-b py-2">
                                            <span>{item.name}</span>
                                            <span className="font-bold">Rp {item.price.toLocaleString()}</span>
                                        </div>
                                    ))}
                                    <div className="mt-4 pt-4 border-t-2 border-dashed flex justify-between font-black text-xl">
                                        <span>TOTAL</span>
                                        <span>Rp {cart.reduce((s, i) => s + i.price, 0).toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        )}
                        {tab === 'stok' && <div className="text-center p-10">Fitur Stok Aktif di IndexedDB</div>}
                    </main>

                    {showScanner && <Scanner onScan={handleScan} onClose={() => setShowScanner(false)} />}

                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t flex justify-around p-4 shadow-2xl">
                        <button onClick={() => setTab('kasir')} className={tab === 'kasir' ? 'text-blue-600 font-bold' : 'text-gray-400'}>KASIR</button>
                        <button onClick={() => setTab('stok')} className={tab === 'stok' ? 'text-blue-600 font-bold' : 'text-gray-400'}>STOK</button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
